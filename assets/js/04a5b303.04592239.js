"use strict";(self.webpackChunkcasdk_docs=self.webpackChunkcasdk_docs||[]).push([[5535],{5711:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>c,toc:()=>l});var t=r(4848),o=r(5680);const a={},i="Use Carbon Aware SDK with an Azure Function",c={id:"samples/azure/azure-function/README",title:"Use Carbon Aware SDK with an Azure Function",description:"Overview",source:"@site/docs/samples/azure/azure-function/README.md",sourceDirName:"samples/azure/azure-function",slug:"/samples/azure/azure-function/",permalink:"/docs/samples/azure/azure-function/",draft:!1,unlisted:!1,editUrl:"https://github.com/Green-Software-Foundation/carbon-aware-sdk/docs/samples/azure/azure-function/README.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"README",permalink:"/docs/samples/azure/apim-policy/"},next:{title:"Java Client Example",permalink:"/docs/samples/java-client/"}},s={},l=[{value:"Overview",id:"overview",level:2},{value:"Azure Function Dependency Injection",id:"azure-function-dependency-injection",level:2},{value:"Run Function Locally",id:"run-function-locally",level:2},{value:"Prerequisites to Run",id:"prerequisites-to-run",level:3},{value:"Start Function",id:"start-function",level:3},{value:"<em>Example call for Get Average Carbon Intensity function</em>",id:"example-call-for-get-average-carbon-intensity-function",level:4},{value:"<em>Example call for Get Current Forecast function</em>",id:"example-call-for-get-current-forecast-function",level:4},{value:"Deploy to Azure",id:"deploy-to-azure",level:2},{value:"Prerequisites to Deploy",id:"prerequisites-to-deploy",level:3},{value:"Create Function App",id:"create-function-app",level:3},{value:"Publish Functions",id:"publish-functions",level:3},{value:"References",id:"references",level:2}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,o.RP)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"use-carbon-aware-sdk-with-an-azure-function",children:"Use Carbon Aware SDK with an Azure Function"}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(n.p,{children:["The sample included showcase the Azure Functions tooling for the Carbon Aware\nSDK ",(0,t.jsx)(n.a,{href:"../../docs/architecture/c-sharp-client-library.md",children:"C# Class Library"}),". It\nincludes an implementation for ",(0,t.jsx)(n.code,{children:"GetAverageCarbonIntensity"})," and for\n",(0,t.jsx)(n.code,{children:"GetCurrentForecast"}),". ",(0,t.jsx)(n.code,{children:"GetAverageCarbonIntensity"})," uses the ",(0,t.jsx)(n.code,{children:"EmissionsHandler"})," to\nreturn the carbon intensity rate of a location for a specific timespan.\n",(0,t.jsx)(n.code,{children:"GetCurrentForecast"})," uses the ",(0,t.jsx)(n.code,{children:"ForecastHandler"})," to yield the optimal time of a\nspecified location and duration."]}),"\n",(0,t.jsxs)(n.p,{children:["The functions can run locally for debugging or be deployed to Azure. See the\n",(0,t.jsx)(n.a,{href:"../../docs/configuration.md#datasources",children:"data source configuration docs"})," for\ndetailed information about configuring the data source(s) your Azure Function\nwill use."]}),"\n",(0,t.jsx)(n.h2,{id:"azure-function-dependency-injection",children:"Azure Function Dependency Injection"}),"\n",(0,t.jsxs)(n.p,{children:["The Carbon Aware SDK is included in the function .csproj file by\n",(0,t.jsx)(n.a,{href:"../../docs/packaging.md#included-scripts",children:"creating and adding the SDK as a package"}),".\nThe ",(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(6048).A+"",children:"Program.cs"})," file uses dependency injection to access the\nhandlers in the library. The following code initializes the C# Library:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-C#",children:"    // omitted\n    .ConfigureServices((context,services) => {\n        services.AddApplicationInsightsTelemetryWorkerService();\n        services.ConfigureFunctionsApplicationInsights();\n        services.AddEmissionsServices(context.Configuration);\n        services.AddForecastServices(context.Configuration);\n    })\n    // omitted\n"})}),"\n",(0,t.jsx)(n.h2,{id:"run-function-locally",children:"Run Function Locally"}),"\n",(0,t.jsxs)(n.p,{children:["Both Azure Function apps can be\n",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/azure/azure-functions/functions-develop-local",children:"run locally"}),"\nwithout needing an Azure subscription. The process for running both is the same,\nas they use the same configuration, just call different paths within the SDK."]}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites-to-run",children:"Prerequisites to Run"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://dotnet.microsoft.com/download",children:".NET Core SDK"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/azure-functions/functions-run-local",children:"Azure Functions Core Tools"})}),"\n",(0,t.jsx)(n.h3,{id:"start-function",children:"Start Function"}),"\n",(0,t.jsxs)(n.p,{children:["To run and debug locally, update the ",(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(7250).A+"",children:"appsettings.json"})," file\nto include the desired ",(0,t.jsx)(n.a,{href:"../../docs/configuration.md",children:"configuration"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["In the app folder (",(0,t.jsx)(n.code,{children:"samples/azure/azure-function"}),"), run the command: ",(0,t.jsx)(n.code,{children:"func start"})]}),"\n",(0,t.jsx)(n.p,{children:"After the function has compiled and is running, the URLs to the functions will\nbe presented."}),"\n",(0,t.jsx)(n.h4,{id:"example-call-for-get-average-carbon-intensity-function",children:(0,t.jsx)(n.em,{children:"Example call for Get Average Carbon Intensity function"})}),"\n",(0,t.jsx)(n.p,{children:"The following example will retrieve the Average Carbon Intensity. For this\nexample, query parameters were used, but the values could also be sent in the\nbody of the request."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl --location --request GET 'http://localhost:7071/api/GetAverageCarbonIntensity?startDate=2022-03-01T15:30:00Z&endDate=2022-03-01T18:30:00Z&location=eastus'\n"})}),"\n",(0,t.jsx)(n.h4,{id:"example-call-for-get-current-forecast-function",children:(0,t.jsx)(n.em,{children:"Example call for Get Current Forecast function"})}),"\n",(0,t.jsx)(n.p,{children:"The following example will call the Current Forecast route. The request can use\neither the request body or query parameters."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'curl --location --request GET \'http://localhost:7071/api/GetCurrentForecast\' \\\n--header \'Content-Type: application/json\' \\\n--data-raw \'{\n    "startDate": "2022-11-02T15:30:00Z",\n    "endDate": "2022-11-02T18:30:00Z",\n    "location" : "eastus",\n    "duration": 15\n}\'\n'})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Note: startDate and endDate must be a valid interval within the future 24\nhours from the time of calling."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"deploy-to-azure",children:"Deploy to Azure"}),"\n",(0,t.jsx)(n.p,{children:"If you have an Azure subscription, you can also deploy these functions to Azure."}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites-to-deploy",children:"Prerequisites to Deploy"}),"\n",(0,t.jsxs)(n.p,{children:["You must have the\n",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/cli/azure/install-azure-cli",children:"Azure CLI"})," or\n",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/powershell/azure/install-az-ps",children:"Azure PowerShell"}),"\ninstalled locally to be able to publish to Azure."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/azure-functions/functions-run-local",children:"Azure Functions Core Tools"})}),"\n",(0,t.jsx)(n.h3,{id:"create-function-app",children:"Create Function App"}),"\n",(0,t.jsxs)(n.p,{children:["Log in to Azure: ",(0,t.jsx)(n.code,{children:"az login"})]}),"\n",(0,t.jsx)(n.p,{children:"Once the correct subscription is selected run the following script to create a\nnew function app:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Function app and storage account names must be unique.\n\n# Variable block\nlet "randomIdentifier=$RANDOM*$RANDOM"\nlocation="eastus"\nresourceGroup="carbon-aware-$randomIdentifier"\nstorage="casaccount$randomIdentifier"\nfunctionApp="carbon-aware-functionapp-$randomIdentifier"\nskuStorage="Standard_LRS"\nfunctionsVersion="3"\n\n# Create a resource group\necho "Creating $resourceGroup in "$location"..."\naz group create --name $resourceGroup --location "$location"\n\n# Create an Azure storage account in the resource group.\necho "Creating $storage"\naz storage account create --name $storage --location "$location" --resource-group $resourceGroup --sku $skuStorage\n\n# Create a serverless function app in the resource group.\necho "Creating $functionApp"\naz functionapp create --name $functionApp --storage-account $storage --consumption-plan-location "$location" --resource-group $resourceGroup --functions-version $functionsVersion\n'})}),"\n",(0,t.jsx)(n.h3,{id:"publish-functions",children:"Publish Functions"}),"\n",(0,t.jsxs)(n.p,{children:["Update the ",(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(7250).A+"",children:"appsettings.json"})," file to include the desired\n",(0,t.jsx)(n.a,{href:"../../docs/configuration.md",children:"configuration"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"To publish the function code to a function app in Azure, use the publish command\nin the samples/azure/azure-function folder:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"func azure functionapp publish $functionApp\n"})}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference?tabs=blob",children:"Azure Functions developer guide"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/azure-functions/functions-dotnet-dependency-injection",children:"Use dependency injection in .NET Azure Functions"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=v4%2Cwindows%2Ccsharp%2Cportal%2Cbash#start",children:"Run functions locally"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/azure-functions/scripts/functions-cli-create-serverless?source=recommendations",children:"Create a function app for serverless code execution"})})]})}function d(e={}){const{wrapper:n}={...(0,o.RP)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},5680:(e,n,r)=>{r.d(n,{RP:()=>l});var t=r(6540);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function c(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var s=t.createContext({}),l=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},d=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,d=c(e,["components","mdxType","originalType","parentName"]),h=l(r),p=o,f=h["".concat(s,".").concat(p)]||h[p]||u[p]||a;return r?t.createElement(f,i(i({ref:n},d),{},{components:r})):t.createElement(f,i({ref:n},d))}));d.displayName="MDXCreateElement"},6048:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/files/Program-11e8deed10835caec0ee1ee2f7dc05b8.cs"},7250:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/files/appsettings-c5546b12aae431bf752aa097c9902bf3.json"}}]);